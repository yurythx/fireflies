{% extends 'includes/base_cadastros.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<!-- MENSAGENS DE SUCESSO / ERRO -->
{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- CONTAINER PRINCIPAL -->
<div class="container mt-5">

  <!-- CABEÇALHO DA PÁGINA -->
  <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded shadow-sm">
    <a href="{% url 'fornecedores:lista_fornecedores' %}" class="text-decoration-none">
      <h1 class="display-5 fw-bold text-primary">Lista de Fornecedores</h1>
    </a>
    <button class="btn btn-success" onclick="abrirModal('{% url 'fornecedores:novo_fornecedor' %}', 'Novo Fornecedor')">
      <i class="fas fa-building me-1"></i> Novo Fornecedor
    </button>
  </div>

  <!-- FORMULÁRIO DE BUSCA -->
  <form method="get" action="{% url 'fornecedores:lista_fornecedores' %}" class="mb-4">
    <div class="input-group">
      <input type="text" name="nome" value="{{ request.GET.nome }}" class="form-control" placeholder="Buscar por nome">
      <input type="text" name="cnpj" value="{{ request.GET.cnpj }}" class="form-control" placeholder="Buscar por CNPJ">
      <button class="btn btn-primary" type="submit">
        <i class="fas fa-search"></i> Buscar
      </button>
    </div>
  </form>

  <!-- LISTA DE FORNECEDORES -->
  <div class="list-group shadow-sm" id="lista-fornecedores">
    {% for fornecedor in fornecedores %}
    <div class="list-group-item d-flex justify-content-between align-items-center mb-3 p-3 rounded-3 border border-light bg-light">
      <!-- Dados do Fornecedor -->
      <div class="d-flex align-items-center">
        <span class="badge bg-primary me-3">{{ forloop.counter }}</span>
        <div>
          <h5 class="mb-1">
            <a href="javascript:void(0);" class="text-primary fw-bold text-decoration-none"
               onclick="abrirModalDetalhes('{% url 'fornecedores:detalhes_fornecedor' fornecedor.slug %}')">
              {{ fornecedor.nome }}
            </a>
          </h5>
          <p class="mb-1 text-muted">{{ fornecedor.email }}</p>
          {% if fornecedor.cnpj %}
            <p class="mb-1"><strong>CNPJ:</strong> {{ fornecedor.cnpj }}</p>
          {% elif fornecedor.cpf %}
            <p class="mb-1"><strong>CPF:</strong> {{ fornecedor.cpf }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Ações -->
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary"
                onclick="abrirModalDetalhes('{% url 'fornecedores:detalhes_fornecedor' fornecedor.slug %}')"
                title="Detalhes do Fornecedor">
          <i class="fas fa-info-circle"></i>
        </button>
        <button class="btn btn-sm btn-outline-warning"
                onclick="abrirModal('{% url 'fornecedores:editar_fornecedor' fornecedor.slug %}', 'Editar Fornecedor')"
                title="Editar Fornecedor">
          <i class="fas fa-edit me-1"></i> Editar
        </button>
        <button class="btn btn-sm btn-outline-danger"
              onclick="abrirModal('{% url 'fornecedores:excluir_fornecedor' fornecedor.slug %}', 'Excluir Fornecedor')"
              title="Excluir Fornecedor">
              <i class="fas fa-trash-alt me-1"></i> Excluir
        </button>
      </div>
    </div>
    {% empty %}
    <div class="list-group-item text-center text-muted">Nenhum fornecedor encontrado.</div>
    {% endfor %}
  </div>

  <!-- MODAL PRINCIPAL -->
  <div class="modal fade" id="fornecedorModal" tabindex="-1" aria-labelledby="fornecedorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="fornecedorModalLabel">Carregando...</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" id="modalBody">
          Carregando...
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock content %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Incluir os Scripts de Modal, AJAX, etc. -->
{{ block.super }}

<script>
  const urlCidadesPorEstado = "{% url 'enderecos:cidades_por_estado' 0 %}".replace('/0/', '/');

  function abrirModalGenerico(url, titulo = 'Carregando...') {
    const modalLabel = document.getElementById('fornecedorModalLabel');
    const modalBody = document.getElementById('modalBody');

    modalLabel.textContent = titulo;
    modalBody.innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
      </div>
    `;

    fetch(url, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Erro ao carregar o conteúdo');
      return response.text();
    })
    .then(html => {
      modalBody.innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('fornecedorModal'));
      modal.show();
      ativarListenersEndereco?.();
    })
    .catch(() => {
      modalBody.innerHTML = '<div class="alert alert-danger">Erro ao carregar conteúdo.</div>';
    });
  }

  function abrirModal(url, titulo = 'Formulário') {
    abrirModalGenerico(url, titulo);
  }

  function abrirModalDetalhes(url) {
    abrirModalGenerico(url, 'Detalhes do Fornecedor');
  }

  function ativarListenersEndereco() {
    const estadoSelect = document.getElementById('id_estado');
    const cidadeSelect = document.getElementById('id_cidade');

    if (!estadoSelect || !cidadeSelect) return;

    estadoSelect.addEventListener('change', () => {
      const estadoId = estadoSelect.value;
      cidadeSelect.innerHTML = '<option value="">Carregando...</option>';

      if (estadoId) {
        fetch(`${urlCidadesPorEstado}${estadoId}/`)
          .then(res => res.json())
          .then(data => {
            cidadeSelect.innerHTML = '';
            if (data.cidades?.length) {
              data.cidades.forEach(cidade => {
                const option = document.createElement('option');
                option.value = cidade.id;
                option.textContent = cidade.nome;
                cidadeSelect.appendChild(option);
              });
            } else {
              cidadeSelect.innerHTML = '<option value="">Nenhuma cidade encontrada</option>';
            }
          })
          .catch(() => {
            cidadeSelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
          });
      } else {
        cidadeSelect.innerHTML = '<option value="">Selecione um estado</option>';
      }
    });

    estadoSelect.dispatchEvent(new Event('change'));
  }

  document.addEventListener('submit', async function (e) {
    const form = e.target;
    if (form.closest('#fornecedorModal')) {
      e.preventDefault();
      limparErrosFormulario();

      const btnSubmit = form.querySelector('[type="submit"]');
      if (btnSubmit) {
        btnSubmit.disabled = true;
        btnSubmit.textContent = 'Salvando...';
      }

      const formData = new FormData(form);
      const url = form.action;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
          bootstrap.Modal.getInstance(document.getElementById('fornecedorModal')).hide();
          atualizarListaFornecedores();
          mostrarToast(data.message || 'Operação realizada com sucesso!');
        } else {
          exibirErrosFormulario(data.errors || {}, data.endereco_errors || {});
          mostrarToast('Verifique os erros no formulário.', 'danger');
        }
      } catch (error) {
        console.error('Erro no envio do formulário:', error);
        mostrarToast('Erro ao processar requisição.', 'danger');
      } finally {
        if (btnSubmit) {
          btnSubmit.disabled = false;
          btnSubmit.textContent = 'Salvar';
        }
      }
    }
  });

  function exibirErrosFormulario(errors, enderecoErrors) {
    const todosErros = {
      ...errors,
      ...Object.fromEntries(
        Object.entries(enderecoErrors).map(([k, v]) => [`endereco-${k}`, v])
      )
    };

    for (let campo in todosErros) {
      const input = document.getElementById(`id_${campo}`);
      if (input) {
        input.classList.add('is-invalid');
        const erro = document.createElement('div');
        erro.className = 'invalid-feedback d-block';
        erro.innerText = todosErros[campo][0];
        input.insertAdjacentElement('afterend', erro);
      }
    }
  }

  function limparErrosFormulario() {
    document.querySelectorAll('.invalid-feedback').forEach(e => e.remove());
    document.querySelectorAll('.is-invalid').forEach(e => e.classList.remove('is-invalid'));
  }

  function atualizarListaFornecedores() {
    fetch("{% url 'fornecedores:lista_fornecedores' %}", {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(res => res.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const novaLista = doc.querySelector('#lista-fornecedores');
      if (novaLista) {
        document.querySelector('#lista-fornecedores')?.replaceWith(novaLista);
      }
    })
    .catch(err => {
      console.error('Erro ao atualizar lista:', err);
      mostrarToast('Erro ao atualizar lista de fornecedores.', 'danger');
    });
  }

  function mostrarToast(mensagem, tipo = 'success') {
    const toastContainer = document.createElement('div');
    toastContainer.className = `toast align-items-center text-bg-${tipo} border-0 position-fixed bottom-0 end-0 m-3`;
    toastContainer.setAttribute('role', 'alert');
    toastContainer.setAttribute('aria-live', 'assertive');
    toastContainer.setAttribute('aria-atomic', 'true');

    toastContainer.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${mensagem}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    `;

    document.body.appendChild(toastContainer);
    const toast = new bootstrap.Toast(toastContainer);
    toast.show();

    toastContainer.addEventListener('hidden.bs.toast', () => {
      toastContainer.remove();
    });
  }

</script>

<script>
  function excluirFornecedor(slug) {
    if (confirm('Tem certeza que deseja excluir este fornecedor?')) {
      fetch(`/fornecedores/${slug}/excluir/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById(`fornecedor-${slug}`)?.remove();
          mostrarToast(data.message || 'Fornecedor excluído com sucesso!');
        } else {
          mostrarToast('Erro ao excluir fornecedor.', 'danger');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        mostrarToast('Erro ao excluir fornecedor.', 'danger');
      });
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
