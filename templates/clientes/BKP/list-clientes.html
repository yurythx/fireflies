{% extends 'includes/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<main class="main">

  <!-- Hero Section -->
  <section id="hero" class="hero section dark-background">
    <img src="{% static 'pages/assets/img/world-dotted-map.png' %}" alt="Mapa Mundi Pontilhado" class="hero-bg" data-aos="fade-in">

    <div class="container">
      <div class="row gy-4 justify-content-between">
        <form action="{% url 'clientes:list-clientes' %}" method="get" class="form-search d-flex align-items-stretch mb-3 w-100" data-aos="fade-up" data-aos-delay="200">
          <input type="text" class="form-control me-2" name="search" placeholder="Buscar cliente..." value="{{ request.GET.search }}">
          <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Buscar</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Clientes Section -->
  <section id="clientes-section" class="clientes-section section py-5">
    <div class="container">
      <div class="clientes-list">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h3">Lista de Clientes</h1>
         <!-- Botão para abrir o modal -->
<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createClienteModal">
  <i class="bi bi-plus-circle"></i> Novo Cliente
</button>

<!-- Modal -->
<div class="modal fade" id="createClienteModal" tabindex="-1" aria-labelledby="createClienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <!-- Formulário com Django Forms -->
      <form method="post" action="{% url 'clientes:new-cliente' %}">
        {% csrf_token %}

        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="createClienteModalLabel">Novo Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          {{ form|crispy }}
          {% if form.errors %}
            <div class="alert alert-danger">
              <strong>Erros encontrados:</strong>
              <ul class="mb-0">
                {% for field in form %}
                  {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>

    </div>
  </div>
</div>
        </div>

        <!-- Filtros -->
        <form method="get" class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="estado" class="form-label">Estado</label>
            <select name="estado" id="estado" class="form-select" onchange="this.form.submit();">
              <option value="">Todos os Estados</option>
              {% for estado in estados %}
                <option value="{{ estado.id }}" {% if estado.id == estado_id %}selected{% endif %}>{{ estado.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label for="cidade" class="form-label">Cidade</label>
            <select name="cidade" id="cidade" class="form-select" onchange="this.form.submit();">
              <option value="">Todas as Cidades</option>
              {% for cidade in cidades %}
                <option value="{{ cidade.id }}" {% if cidade.id == cidade_id %}selected{% endif %}>{{ cidade.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </form>

        <!-- Tabela de Clientes -->
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Telefone</th>
                <th class="text-center">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for cliente in clientes %}
                <tr>
                  <td>{{ cliente.nome }}</td>
                  <td>{{ cliente.email }}</td>
                  <td>{{ cliente.telefone }}</td>

                  <td class="text-center">
                      <!-- Botão para abrir o modal -->
                    <button type="button" class="btn btn-sm btn-warning me-1" title="Editar" data-bs-toggle="modal" data-bs-target="#editModal{{ cliente.slug }}">
                      <i class="bi bi-pencil"></i>
                    </button>

                    <!-- Botão para abrir o modal -->
                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ cliente.slug }}">
                      <i class="bi bi-trash"></i>
                    </button>

                    <!-- Modal de Edição -->
                    <div class="modal fade" id="editModal{{ cliente.slug }}" tabindex="-1" aria-labelledby="editModalLabel{{ cliente.slug }}" aria-hidden="true">
                      <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                          <form method="post" action="{% url 'clientes:update-cliente' cliente.slug %}">
                            {% csrf_token %}
                            <div class="modal-header bg-warning text-dark">
                              <h5 class="modal-title" id="editModalLabel{{ cliente.slug }}">Editar Cliente</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                              <!-- Aqui você deve renderizar os campos manualmente ou incluir um partial -->
                              <div class="mb-3">
                                <label for="nome{{ cliente.slug }}" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="nome{{ cliente.slug }}" name="nome" value="{{ cliente.nome }}">
                              </div>
                              <div class="mb-3">
                                <label for="email{{ cliente.slug }}" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email{{ cliente.slug }}" name="email" value="{{ cliente.email }}">
                              </div>
                              <div class="mb-3">
                                <label for="telefone{{ cliente.slug }}" class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="telefone{{ cliente.slug }}" name="telefone" value="{{ cliente.telefone }}">
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-warning">Salvar Alterações</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Modal de excluir -->
                    <div class="modal fade" id="deleteModal{{ cliente.slug }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ cliente.slug }}" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <form method="post" action="{% url 'clientes:delete-cliente' cliente.slug %}">
                            {% csrf_token %}
                            <div class="modal-header bg-danger text-white">
                              <h5 class="modal-title" id="deleteModalLabel{{ cliente.slug }}">Confirmar Exclusão</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                              Deseja realmente excluir o cliente <strong>{{ cliente.nome }}</strong>?
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-danger">Excluir</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center">Nenhum cliente encontrado.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Paginação -->
        {% if clientes.paginator.num_pages > 1 %}
        <nav class="mt-4">
          <ul class="pagination justify-content-center">
            {% if clientes.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if estado_id %}&estado={{ estado_id }}{% endif %}{% if cidade_id %}&cidade={{ cidade_id }}{% endif %}">&laquo; Primeira</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ clientes.previous_page_number }}{% if estado_id %}&estado={{ estado_id }}{% endif %}{% if cidade_id %}&cidade={{ cidade_id }}{% endif %}">Anterior</a>
              </li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">Página {{ clientes.number }} de {{ clientes.paginator.num_pages }}</span>
            </li>

            {% if clientes.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ clientes.next_page_number }}{% if estado_id %}&estado={{ estado_id }}{% endif %}{% if cidade_id %}&cidade={{ cidade_id }}{% endif %}">Próxima</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ clientes.paginator.num_pages }}{% if estado_id %}&estado={{ estado_id }}{% endif %}{% if cidade_id %}&cidade={{ cidade_id }}{% endif %}">Última &raquo;</a>
              </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </section>

</main>
{% endblock content %}

<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
  <i class="bi bi-arrow-up-short"></i>
</a>

<!-- Preloader -->
<div id="preloader"></div>

<!-- Bootstrap JS (para os modais) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
