{% extends 'includes/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<!-- MENSAGENS -->
{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- LISTA DE CLIENTES -->
<div class="container mt-5">
  <h1>Clientes</h1>
  <button class="btn btn-primary mb-3" onclick="abrirModal('{% url 'clientes:novo_cliente' %}', 'Novo Cliente')">
    <i class="fas fa-user-plus"></i> Novo Cliente
  </button>

  <ul class="list-group">
    {% for cliente in clientes %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ cliente.nome }}</strong> - {{ cliente.email }}
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="abrirModal('{% url 'clientes:editar_cliente' cliente.slug %}', 'Editar Cliente')">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="abrirModal('{% url 'clientes:excluir_cliente' cliente.slug %}', 'Excluir Cliente')">
            <i class="fas fa-trash-alt"></i> Excluir
          </button>
        </div>
      </li>
    {% endfor %}
  </ul>
</div>

<!-- MODAL PRINCIPAL -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clienteModalLabel">Carregando...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" id="modalBody">
        Carregando...
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_scripts %}
<!-- JQUERY -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- BOOTSTRAP JS (essencial para os modais) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- JS AJAX & MODAL -->
<script>
  function abrirModal(url, titulo = 'Detalhes') {
    $('#clienteModalLabel').text(titulo);
    $('#modalBody').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>');

    $.get(url, function(data) {
      $('#modalBody').html(data);
      const modalEl = document.getElementById('clienteModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }).fail(function() {
      $('#modalBody').html('<div class="alert alert-danger">Erro ao carregar o conteúdo.</div>');
    });
  }

  function salvarForm(event, formElement) {
    event.preventDefault();
    const form = $(formElement);
    const url = form.attr('action');

    $.ajax({
      url: url,
      type: 'POST',
      data: form.serialize(),
      success: function(response) {
        if (response.success) {
          const modal = bootstrap.Modal.getInstance(document.getElementById('clienteModal'));
          modal.hide();
          location.reload();
        } else {
          $('#modalBody').html(response.html || "Erro desconhecido");
        }
      },
      error: function(xhr) {
        console.error('Erro ao enviar o formulário:', xhr.responseText);
        $('#modalBody').html('<div class="alert alert-danger">Erro inesperado no envio.</div>');
      }
    });
  }

  function excluirCliente(event, form) {
    event.preventDefault();
    const url = form.action;

    $.ajax({
      url: url,
      type: 'POST',
      data: $(form).serialize(),
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(response) {
        if (response.success) {
          $('#modalBody').html(`<div class="alert alert-success">${response.message}</div>`);
          setTimeout(() => location.reload(), 1500);
        } else {
          $('#modalBody').html('<div class="alert alert-danger">Erro ao excluir</div>');
        }
      },
      error: function(xhr) {
        $('#modalBody').html('<div class="alert alert-danger">Erro ao excluir (servidor)</div>');
      }
    });
  }
</script>
{% endblock %}
